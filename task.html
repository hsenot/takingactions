<!DOCTYPE html>
<html>
  <head>
    <title>Taking Action(s)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <style>
      .carousel-inner>.item>img {
        margin: 0 auto;
        height: 300px;
      }
    </style>
    
  </head>
  <body>
    <div class="container" style="padding-top:15px;">
      <h3 class="text-center">The task is to:</h3>
      <div class="jumbotron">
        <div id="mytask" class="text-center" style="font-size:48px;">
        </div>
      </div>

      <h3 id="titleCarousel" class="text-center"></h3>
      <div id="contrib-carousel" class="carousel slide" data-ride="carousel">
      </div>

      <div>
        <h3 class="text-center">Get busy, then send us your contribution:</h3>
        <div class="row">
          <div class="col-xs-3 col-md-3 text-center"><img src="pix/bubbles.png" width=100></div>
          <div class="col-xs-3 col-md-3 text-center"><a class="mailto_link" href="mailto:iam@takingactions.org"><img src="pix/email_square.png" width=100></a></div>
          <div class="col-xs-3 col-md-3 text-center"><img src="pix/mail_bg.png" width=100></div>
          <div class="col-xs-3 col-md-3 text-center"><img src="pix/moon.png" width=100></div>
        </div>
        <div class="row">
          <div class="col-xs-3 col-md-3 text-center">By text: <br><a href="sms:0430060XYZ">0430 060 XYZ</a></div>
          <div class="col-xs-3 col-md-3 text-center">By email: <br><a class="mailto_link" href="mailto:contribution@takingactions.org">contribution@takingactions.org</a></div>
          <div class="col-xs-3 col-md-3 text-center">By letter or parcel: <br>Taking Action(s)<br>PO Box 24091<br>Melbourne, Vic, 3001</div>
          <div class="col-xs-3 col-md-3 text-center">Or come to the gallery: <br>West Space<br>1/225 Bourke Street<br>Melbourne, Vic, 3000</div>
        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script>
      function getUrlVar(key){
        var result = new RegExp(key + "=([^&]*)", "i").exec(window.location.search); 
        return result && unescape(result[1]) || ""; 
      }

      function pumpACarouselIndicator(slideNb, activeFlag){
        var activeClass = "";
        if (activeFlag)
        {
          activeClass = 'class="active"';
        }
        return '<li data-target="#contrib-carousel" data-slide-to="'+slideNb+'"'+activeClass+'></li>';
      }

      function pumpACarouselItem(url, activeFlag){
        var activeClass = "";
        if (activeFlag)
        {
          activeClass = " active";
        }
        return '<div class="item'+activeClass+'"><img src="images/'+url+'"></div>';
      }

      var task_id = getUrlVar('id');

      // Getting the task from the database
      $.getJSON("ws/ws_get_task.php",
        {
          id: task_id
        },
        function(json){

          var task = json.rows[0];

          // Insert task text into its div
          $('#mytask').html(task.label);

          // Insert task subject into the mailto
          $('.mailto_link').attr("href","mailto:contribution@takingactions.org?subject="+encodeURIComponent(task.label));
        }
      );

      // Getting the contributions into a carousel
      $.getJSON("ws/ws_get_task_contributions.php",
        {
          id: task_id
        },
        function(json_data){
            // Reducing the data to all non-null URLs that correspond to this task
            var json = $.grep(json_data.rows, function(v) {
                return v.url && v.id == task_id;
            });

            // Populating this carousel if there is at least 1 image
            if (json.length>0 && json[0].url)
            {
              // Set carousel title
              $('#titleCarousel').html(json.length+' previous contribution'+((json.length>1)?"s":"")+':');

              // Indicators
              var carou = '<ol class="carousel-indicators">';
              for (var j=0;j<json.length;j++)
              {
                carou += pumpACarouselIndicator(j, (j == 0) );
              }
              carou += '</ol>';

              // Wrapper for slides
              carou += '<div class="carousel-inner">';
              for (var j=0;j<json.length;j++)
              {
                carou += pumpACarouselItem(json[j].url, (j == 0) );
              }
              carou += '</div>';

              <!-- Controls -->
              carou +='<a class="left carousel-control" href="#contrib-carousel" data-slide="prev"> \
                <span class="glyphicon glyphicon-chevron-left"></span> \
              </a> \
              <a class="right carousel-control" href="#contrib-carousel" data-slide="next"> \
                <span class="glyphicon glyphicon-chevron-right"></span> \
              </a>';

              $('#contrib-carousel').append(carou);              
            }
        }
      );     

    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46468762-1', 'takingactions.org');
      ga('send', 'pageview');

    </script>
  </body>
</html>
